namespace XIVComboVX;

using System;
using System.Diagnostics;

using Dalamud.Game;
using Dalamud.Logging;

internal class LogUtil: IDisposable {
	public const string STACK_TRACE_MSG = "autogenerated stack trace exception";
	private bool disposed;

	public bool Enabled { get; protected set; } = false;
	public bool EnabledNextTick { get; protected set; } = false;

	internal LogUtil() {
		Service.Framework.Update += this.onTick;
	}

	public void EnableNextTick() {
		this.EnabledNextTick = true;
		PluginLog.Information("Enabled logging snapshot for next tick");
	}

	private void onTick(Framework framework) {
		if (this.Enabled)
			PluginLog.Information("Logging snapshot complete");
		if (this.EnabledNextTick)
			PluginLog.Information("Beginning logging snapshot");
		this.Enabled = this.EnabledNextTick;
		this.EnabledNextTick = false;
	}

	internal void fatal(string msg, Exception? cause = null) {
		if (this.Enabled)
			PluginLog.Fatal($"{msg}\n{cause ?? new Exception(STACK_TRACE_MSG)}");
	}
	internal void error(string msg, Exception? cause = null) {
		if (this.Enabled)
			PluginLog.Error($"{msg}\n{cause ?? new Exception(STACK_TRACE_MSG)}");
	}
	internal void warning(string msg, Exception? cause = null) {
		if (this.Enabled)
			PluginLog.Warning($"{msg}\n{cause ?? new Exception(STACK_TRACE_MSG)}");
	}
	[Conditional("DEBUG")]
	internal void debug(string msg) {
		if (this.Enabled)
			PluginLog.Information(msg);
	}
	[Conditional("DEBUG")]
	internal void trace(string msg) {
		if (this.Enabled) {
			PluginLog.Information(
#if TRACE
				$"{msg}\n{new StackTrace(true)}"
#else
				msg
#endif
			);
		}
	}

	#region IDisposable

	public void Dispose() {
		if (this.disposed)
			return;
		this.disposed = true;

		Service.Framework.Update -= this.onTick;
	}

	#endregion

}
